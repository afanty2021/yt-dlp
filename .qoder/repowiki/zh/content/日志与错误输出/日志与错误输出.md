# 日志与错误输出

<cite>
**本文档引用的文件**
- [YoutubeDL.py](file://yt_dlp/YoutubeDL.py)
- [utils/_utils.py](file://yt_dlp/utils/_utils.py)
- [test/test_verbose_output.py](file://test/test_verbose_output.py)
</cite>

## 目录
1. [简介](#简介)
2. [日志级别与输出控制](#日志级别与输出控制)
3. [错误分类与异常处理](#错误分类与异常处理)
4. [内部错误检测与报告机制](#内部错误检测与报告机制)
5. [测试验证与输出一致性](#测试验证与输出一致性)
6. [故障排查指南](#故障排查指南)

## 简介
yt-dlp 提供了全面的日志记录和错误处理机制，用于诊断和调试下载过程中的各种情况。该系统通过 `YoutubeDL` 类实现，支持从静默模式到详细调试输出的多种日志级别。日志系统不仅处理常规的警告和错误，还包含专门的异常类来处理特定的下载场景，如地理限制、格式不可用和提取错误等。此外，系统还包含测试用例来验证各种错误场景下的输出一致性。

## 日志级别与输出控制
yt-dlp 的日志系统通过 `YoutubeDL` 类中的多个方法实现，支持不同的日志级别和输出控制。主要的日志级别包括：

- **静默模式 (quiet)**: 当 `quiet` 参数设置为 `True` 时，不会向标准输出打印任何消息。
- **详细模式 (verbose)**: 当 `verbose` 参数设置为 `True` 时，会打印额外的调试信息到标准输出。
- **警告 (warning)**: 使用 `report_warning` 方法打印警告消息，前缀为 "WARNING:"，如果标准错误是终端文件，则会用黄色着色。
- **错误 (error)**: 使用 `report_error` 方法打印错误消息，前缀为 "ERROR:"，如果标准错误是终端文件，则会用红色着色。
- **调试 (debug)**: 使用 `write_debug` 方法记录调试消息或打印到标准错误，仅在 `verbose` 模式下启用。

日志输出可以通过 `logger` 参数进行自定义，该参数接受一个具有 `debug`、`warning` 和 `error` 方法的类。对于兼容性原因，`debug` 和 `info` 消息都会传递给 `debug` 方法。调试消息会有 `[debug]` 前缀以区别于信息消息。

**Section sources**
- [YoutubeDL.py](file://yt_dlp/YoutubeDL.py#L1073-L1102)

## 错误分类与异常处理
yt-dlp 实现了详细的错误分类和异常处理机制，通过继承自 `YoutubeDLError` 的多个异常类来处理不同类型的错误。主要的错误分类包括：

- **ExtractorError**: 在信息提取过程中发生的错误，通常由提取器抛出。
- **DownloadError**: 下载错误异常，当文件下载器配置为在错误时停止时抛出。
- **GeoRestrictedError**: 地理限制错误，当视频由于网站施加的地理限制而无法从您的位置获取时抛出。
- **UnavailableVideoError**: 不可用格式异常，当请求的视频格式不可用时抛出。
- **ContentTooShortError**: 内容过短异常，当下载的文件比服务器最初宣布的小得多时抛出，表明连接可能已中断。
- **PostProcessingError**: 后处理异常，由后处理器的 `.run()` 方法抛出以指示后处理任务中的错误。
- **DownloadCancelled**: 下载取消异常，当下载队列应被中断时抛出。

这些异常类提供了详细的错误信息和上下文，帮助用户诊断问题。例如，`ExtractorError` 包含原始消息、跟踪回溯、是否为预期错误、原因、视频ID和提取器等属性。

**Section sources**
- [utils/_utils.py](file://yt_dlp/utils/_utils.py#L953-L1159)

## 内部错误检测与报告机制
yt-dlp 的内部错误检测和报告机制通过 `YoutubeDL` 类和 `utils/_utils.py` 中的实用函数实现。主要的机制包括：

- **_YDLLogger**: 一个内部日志记录器类，用于将日志消息转发到 `YoutubeDL` 实例的相应方法。它提供了 `debug`、`info`、`warning`、`error`、`stdout` 和 `stderr` 方法。
- **trouble 方法**: 用于确定下载问题出现时采取的行动。根据下载器是否配置为忽略下载错误，此方法可能会抛出异常或不抛出异常，同时打印消息。
- **report_warning 和 report_error 方法**: 分别用于打印警告和错误消息，这些方法会根据配置决定是否实际输出消息。
- **write_debug 方法**: 用于记录调试消息或打印到标准错误，但仅在 `verbose` 模式下启用。

这些机制共同工作，确保错误和警告能够被正确地检测、分类和报告，同时提供足够的上下文信息以便于调试。

**Section sources**
- [utils/_utils.py](file://yt_dlp/utils/_utils.py#L5658-L5684)
- [YoutubeDL.py](file://yt_dlp/YoutubeDL.py#L1073-L1102)

## 测试验证与输出一致性
yt-dlp 通过 `test/test_verbose_output.py` 中的测试用例来验证各种错误场景下的输出一致性。这些测试主要关注敏感信息的保护，确保在详细输出模式下不会泄露用户名和密码等敏感信息。测试用例包括：

- **test_private_info_arg**: 测试使用 `--username` 和 `--password` 参数时，敏感信息是否被正确隐藏。
- **test_private_info_shortarg**: 测试使用 `-u` 和 `-p` 短参数时，敏感信息是否被正确隐藏。
- **test_private_info_eq**: 测试使用 `--username=johnsmith@gmail.com` 形式的等号赋值时，敏感信息是否被正确隐藏。
- **test_private_info_shortarg_eq**: 测试使用 `-u=johnsmith@gmail.com` 形式的短参数等号赋值时，敏感信息是否被正确隐藏。

这些测试通过运行 yt-dlp 命令并检查标准错误输出来验证敏感信息是否被正确隐藏，确保即使在详细输出模式下也不会泄露用户凭证。

**Section sources**
- [test/test_verbose_output.py](file://test/test_verbose_output.py#L0-L75)

## 故障排查指南
当遇到 yt-dlp 的问题时，可以按照以下步骤进行故障排查：

1. **启用详细模式**: 使用 `-v` 或 `--verbose` 参数运行 yt-dlp，以获取详细的调试信息。这可以帮助识别问题的根本原因。
2. **检查错误消息**: 仔细阅读错误消息，特别是前缀为 "ERROR:" 的消息，它们通常包含解决问题的关键信息。
3. **验证网络连接**: 确保您的网络连接正常，特别是当遇到与服务器连接相关的问题时。
4. **检查提取器支持**: 确认您尝试下载的网站是否被支持。可以使用 `--list-extractors` 参数查看所有支持的提取器。
5. **更新 yt-dlp**: 确保您使用的是最新版本的 yt-dlp，因为许多问题可能已经在新版本中得到修复。
6. **检查配置文件**: 如果使用了配置文件，检查其中的设置是否正确，特别是与认证和代理相关的设置。
7. **查看已知问题**: 访问 yt-dlp 的 GitHub 仓库，查看是否有与您遇到的问题相似的已知问题或解决方案。

通过遵循这些步骤，大多数常见的 yt-dlp 问题都可以得到解决。如果问题仍然存在，建议在 GitHub 上提交详细的错误报告，包括完整的命令行、错误消息和任何相关的调试信息。

**Section sources**
- [YoutubeDL.py](file://yt_dlp/YoutubeDL.py#L1073-L1102)
- [utils/_utils.py](file://yt_dlp/utils/_utils.py#L953-L1159)