# 配置文件

<cite>
**本文档中引用的文件**
- [YoutubeDL.py](file://yt_dlp/YoutubeDL.py)
- [options.py](file://yt_dlp/options.py)
- [utils/_utils.py](file://yt_dlp/utils/_utils.py)
- [test/test_config.py](file://test/test_config.py)
- [devscripts/tomlparse.py](file://devscripts/tomlparse.py)
- [README.md](file://README.md)
</cite>

## 目录
1. [简介](#简介)
2. [配置文件系统架构](#配置文件系统架构)
3. [配置文件位置和优先级](#配置文件位置和优先级)
4. [配置文件语法](#配置文件语法)
5. [配置选项详解](#配置选项详解)
6. [配置文件示例](#配置文件示例)
7. [最佳实践](#最佳实践)
8. [故障排除](#故障排除)
9. [总结](#总结)

## 简介

yt-dlp的配置系统提供了灵活而强大的方式来管理下载行为。配置文件允许用户持久化设置，避免每次运行时重复输入相同的命令行参数。该系统支持多种配置文件格式，具有清晰的优先级规则，并与命令行参数完美集成。

## 配置文件系统架构

yt-dlp的配置系统基于分层架构设计，支持多个配置源的组合使用：

```mermaid
graph TD
A[命令行参数] --> B[配置解析器]
C[便携式配置] --> B
D[主目录配置] --> B
E[用户配置] --> B
F[系统配置] --> B
B --> G[最终配置]
H[环境变量] --> I[配置加载器]
J[默认值] --> I
I --> B
G --> K[YoutubeDL对象]
K --> L[下载执行]
```

**图表来源**
- [options.py](file://yt_dlp/options.py#L81-L110)
- [utils/_utils.py](file://yt_dlp/utils/_utils.py#L4878-L4945)

**章节来源**
- [options.py](file://yt_dlp/options.py#L55-L110)
- [utils/_utils.py](file://yt_dlp/utils/_utils.py#L4878-L5000)

## 配置文件位置和优先级

### 配置文件查找顺序

yt-dlp按照以下优先级顺序查找和加载配置文件：

```mermaid
flowchart TD
A[开始] --> B{检查--ignore-config?}
B --> |是| C[跳过所有配置文件]
B --> |否| D[加载便携式配置]
D --> E[加载主目录配置]
E --> F[加载用户配置]
F --> G{检查系统配置中的--ignore-config?}
G --> |是| H[跳过用户配置]
G --> |否| I[加载系统配置]
H --> J[完成]
I --> J
C --> J
```

**图表来源**
- [options.py](file://yt_dlp/options.py#L81-L110)

### 配置文件位置表

| 优先级 | 平台 | 路径 | 文件名 |
|--------|------|------|--------|
| 1 | 便携式 | 可执行文件所在目录 | `yt-dlp.conf` |
| 2 | 主目录 | 用户指定路径 | `yt-dlp.conf` |
| 3 | 用户配置 | `$XDG_CONFIG_HOME/yt-dlp` 或 `~/.config/yt-dlp` | `config`, `config.txt` |
| 3 | 用户配置 | `$APPDATA/yt-dlp` (Windows) | `config`, `config.txt` |
| 3 | 用户配置 | `~/.yt-dlp` | `config`, `config.txt` |
| 4 | 系统配置 | `/etc/yt-dlp` | `config`, `config.txt` |

**章节来源**
- [test/test_config.py](file://test/test_config.py#L45-L85)
- [utils/_utils.py](file://yt_dlp/utils/_utils.py#L4710-L4748)

## 配置文件语法

### 基本语法规则

配置文件使用简单的文本格式，每行一个选项，遵循以下规则：

1. **选项格式**：必须使用短选项或长选项格式，不能有空格后跟`-`或`--`
2. **引号处理**：必要时需要对包含空格的值进行引号包围
3. **注释支持**：以`#`开头的行为注释
4. **编码支持**：支持UTF-8编码，可使用BOM标记

### 编码声明

如果需要特殊编码，可以在文件开头添加编码声明：
```
# coding: utf-8
-o "视频_%(title)s.%(ext)s"
--proxy http://proxy.example.com:8080
```

### 配置文件解析流程

```mermaid
sequenceDiagram
participant User as 用户
participant Parser as 配置解析器
participant File as 配置文件
participant Shlex as Shlex模块
participant Args as 参数列表
User->>Parser : 加载配置文件
Parser->>File : 读取文件内容
File-->>Parser : 返回原始文本
Parser->>Shlex : 解析命令行参数
Shlex-->>Parser : 返回参数列表
Parser->>Args : 构建参数对象
Args-->>User : 配置就绪
```

**图表来源**
- [utils/_utils.py](file://yt_dlp/utils/_utils.py#L4945-L4970)

**章节来源**
- [utils/_utils.py](file://yt_dlp/utils/_utils.py#L4878-L4918)
- [README.md](file://README.md#L1190-L1200)

## 配置选项详解

### 下载路径配置

| 选项 | 类型 | 描述 | 示例 |
|------|------|------|------|
| `--paths` | 字典 | 指定不同类型文件的保存路径 | `-P home:/downloads -P temp:/tmp` |
| `--output` | 模板 | 输出文件名模板 | `-o "%(title)s.%(ext)s"` |
| `--restrict-filenames` | 布尔 | 限制文件名为ASCII字符 | `--restrict-filenames` |
| `--windows-filenames` | 布尔 | 强制Windows兼容文件名 | `--windows-filenames` |

### 格式选择配置

| 选项 | 类型 | 描述 | 示例 |
|------|------|------|------|
| `--format` | 字符串 | 视频格式选择器 | `-f "best[height<=720]"` |
| `--format-sort` | 列表 | 格式排序字段 | `-S height,width` |
| `--merge-output-format` | 字符串 | 合并输出格式 | `--merge-output-format mp4` |
| `--prefer-free-formats` | 布尔 | 优先选择免费容器格式 | `--prefer-free-formats` |

### 网络设置配置

| 选项 | 类型 | 描述 | 示例 |
|------|------|------|------|
| `--proxy` | 字符串 | 代理服务器设置 | `--proxy http://proxy:8080` |
| `--socket-timeout` | 数字 | 连接超时时间（秒） | `--socket-timeout 30` |
| `--user-agent` | 字符串 | 自定义User-Agent | `--user-agent "CustomAgent/1.0"` |
| `--add-headers` | 字典 | 自定义HTTP头 | `--add-headers "Referer:https://site.com"` |

### 认证配置

| 选项 | 类型 | 描述 | 示例 |
|------|------|------|------|
| `--username` | 字符串 | 用户名 | `--username user@example.com` |
| `--password` | 字符串 | 密码 | `--password secret` |
| `--netrc` | 布尔 | 使用.netrc文件 | `--netrc` |
| `--cookies` | 字符串 | Cookie文件路径 | `--cookies cookies.txt` |

**章节来源**
- [options.py](file://yt_dlp/options.py#L1333-L1400)
- [options.py](file://yt_dlp/options.py#L800-L1200)

## 配置文件示例

### 基础配置文件

```bash
# 基础下载配置
-o "/downloads/%(title)s.%(ext)s"
-P home:/downloads
-P temp:/tmp/downloads
--restrict-filenames
--continue

# 格式选择
-f "bestvideo[height<=1080]+bestaudio/best"
-S "res,br,codec:av01"
--merge-output-format mp4

# 网络设置
--proxy http://proxy:8080
--socket-timeout 30
--user-agent "Mozilla/5.0 (compatible; yt-dlp)"

# 认证设置
--netrc
--cookies /home/user/.yt-dlp/cookies.txt
```

### 高级配置文件

```bash
# 高级下载配置
-o "/media/videos/%(upload_date)s_%(title)s.%(ext)s"
-P home:/media/videos
-P temp:/tmp/downloads
--restrict-filenames
--windows-filenames

# 多格式选择
-f "bestvideo[height<=1080][vcodec!=av01]+bestaudio/best"
-S "res,hdr,br,asr,codec"
--prefer-free-formats
--check-formats

# 网络优化
--proxy socks5://user:pass@proxy:1080
--socket-timeout 60
--retries 5
--fragment-retries 10
--buffer-size 1024

# 认证和安全
--netrc
--cookies-from-browser chrome
--no-check-certificates

# 下载行为
--no-overwrites
--continue
--part
--no-mtime
--write-description
--write-info-json
--write-thumbnail
--write-subs
--sub-langs en,zh*
```

### 工作区专用配置

```bash
# 工作区专用配置
-o "/work/downloads/%(uploader)s/%(title)s.%(ext)s"
-P home:/work/downloads
-P temp:/work/tmp

# 特定平台优化
-f "best[height<=720]"
--proxy ""
--socket-timeout 120

# 元数据保留
--write-info-json
--write-description
--write-thumbnail
--write-comments

# 批量处理
--batch-file /work/downloads/batch.txt
--max-downloads 100
--download-archive /work/downloads/archive.txt
```

## 最佳实践

### 配置文件组织

1. **按用途分类**：为不同使用场景创建专门的配置文件
2. **继承机制**：利用配置文件的合并特性
3. **环境隔离**：为开发、测试、生产环境分别配置

### 性能优化配置

```bash
# 性能优化配置
--concurrent-fragments 4
--max-sleep-interval 10
--buffer-size 8192
--http-chunk-size 10485760
--no-resize-buffer
```

### 安全配置建议

```bash
# 安全配置
--no-check-certificates  # 仅在必要时使用
--client-certificate /path/to/client.pem
--client-certificate-key /path/to/key.pem
--no-cache-dir  # 避免敏感信息缓存
```

### 错误处理配置

```bash
# 错误处理配置
--retries 10
--fragment-retries 5
--file-access-retries 3
--retry-sleep linear=1:10:2
--abort-on-error  # 生产环境推荐
```

## 故障排除

### 常见问题及解决方案

#### 配置文件不生效

**问题**：配置文件中的设置没有被应用

**原因**：
1. 配置文件路径错误
2. 选项格式不正确
3. 命令行参数覆盖了配置

**解决方案**：
```bash
# 检查配置文件加载
yt-dlp --ignore-config -o test.conf

# 验证配置文件语法
cat ~/.config/yt-dlp/config | grep -v '^#' | tr ' ' '\n'
```

#### 编码问题

**问题**：配置文件中的非ASCII字符显示异常

**解决方案**：
```bash
# 添加编码声明
echo '# coding: utf-8' > ~/.config/yt-dlp/config
```

#### 权限问题

**问题**：配置文件权限不足

**解决方案**：
```bash
# 设置正确的权限
chmod 600 ~/.config/yt-dlp/config
```

### 调试配置加载

```bash
# 启用详细日志
yt-dlp --verbose --ignore-config -o test.conf

# 检查配置解析过程
yt-dlp --dump-json --simulate URL
```

**章节来源**
- [test/test_config.py](file://test/test_config.py#L115-L163)

## 总结

yt-dlp的配置系统提供了强大而灵活的方式来管理下载行为。通过合理使用配置文件，用户可以：

1. **简化命令行操作**：避免重复输入相同参数
2. **提高工作效率**：快速切换不同的下载配置
3. **保持一致性**：确保在不同环境中使用相同的设置
4. **便于维护**：集中管理复杂的下载配置

掌握配置文件的语法、优先级和最佳实践，能够帮助用户充分发挥yt-dlp的功能潜力，实现高效、可靠的视频下载工作流。